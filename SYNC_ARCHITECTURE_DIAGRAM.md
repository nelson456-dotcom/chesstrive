# Rock-Solid Sync - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  EnhancedChessStudyWithSimplifiedBoard Component          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Chapters â”‚ â”‚ Presence â”‚ â”‚ Board    â”‚ â”‚ Diagnostics  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Panel    â”‚ â”‚ Display  â”‚ â”‚ + Moves  â”‚ â”‚ Panel        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ â†‘
                    (state updates / user actions)
                              â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REALTIME CLIENT                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Event Sequencing & Ordering                               â”‚ â”‚
â”‚  â”‚  â€¢ lastAppliedSeq: 42                                      â”‚ â”‚
â”‚  â”‚  â€¢ eventBuffer: [event43, event45] (waiting for event44)  â”‚ â”‚
â”‚  â”‚  â€¢ outbox: {msg1: pending ACK, msg2: pending ACK}         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Callbacks                                                 â”‚ â”‚
â”‚  â”‚  â€¢ move.played â†’ handleMoveEvent()                         â”‚ â”‚
â”‚  â”‚  â€¢ chapter.changed â†’ handleChapterEvent()                  â”‚ â”‚
â”‚  â”‚  â€¢ presence.update â†’ handlePresenceEvent()                 â”‚ â”‚
â”‚  â”‚  â€¢ sync.complete â†’ handleSyncComplete()                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ â†‘
                    (send messages / receive events)
                              â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBSOCKET SERVICE                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Connection Management                                     â”‚ â”‚
â”‚  â”‚  â€¢ WebSocket: ws://localhost:3001                          â”‚ â”‚
â”‚  â”‚  â€¢ State: OPEN / CONNECTING / CLOSED                       â”‚ â”‚
â”‚  â”‚  â€¢ Reconnect: Exponential backoff (max 10s)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Message Routing                                           â”‚ â”‚
â”‚  â”‚  â€¢ onmessage â†’ route to RealtimeClient                     â”‚ â”‚
â”‚  â”‚  â€¢ send(msg) â†’ JSON.stringify â†’ ws.send()                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ â†‘
                      (WebSocket protocol)
                              â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND SERVER (Node.js)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  WebSocket Server (ws library)                             â”‚ â”‚
â”‚  â”‚  â€¢ wss.on('connection', (ws) => {...})                     â”‚ â”‚
â”‚  â”‚  â€¢ JWT Authentication                                      â”‚ â”‚
â”‚  â”‚  â€¢ ws.userId, ws.username, ws.studyId, ws.chapterId       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Message Handler                                           â”‚ â”‚
â”‚  â”‚  â€¢ switch(type):                                           â”‚ â”‚
â”‚  â”‚    - join-study â†’ handleJoinStudy()                        â”‚ â”‚
â”‚  â”‚    - move-made â†’ handleMoveMade()                          â”‚ â”‚
â”‚  â”‚    - chapter-changed â†’ handleChapterChanged()              â”‚ â”‚
â”‚  â”‚    - sync.request â†’ handleSyncRequest()                    â”‚ â”‚
â”‚  â”‚    - presence.heartbeat â†’ handlePresenceHeartbeat()        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Study State (per study)                                   â”‚ â”‚
â”‚  â”‚  studyStates.get(studyId):                                 â”‚ â”‚
â”‚  â”‚  â€¢ seq: 42 (monotonic counter)                             â”‚ â”‚
â”‚  â”‚  â€¢ events: [event1, event2, ..., event42] (last 100)      â”‚ â”‚
â”‚  â”‚  â€¢ presence: Map(userId â†’ {username, chapterId, lastSeen})â”‚ â”‚
â”‚  â”‚  â€¢ chapters: Map(chapterId â†’ {title, order})              â”‚ â”‚
â”‚  â”‚  â€¢ activeChapterId: "chapter123"                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Study Rooms                                               â”‚ â”‚
â”‚  â”‚  studyRooms.get(studyId):                                  â”‚ â”‚
â”‚  â”‚  â€¢ Set of WebSocket connections                            â”‚ â”‚
â”‚  â”‚  â€¢ broadcastToStudy(studyId, message)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Event Flow - Move Played

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client A â”‚                                           â”‚ Client B â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                      â”‚
     â”‚ 1. User plays e4                                    â”‚
     â”‚                                                      â”‚
     â”‚ 2. realtimeClient.send('move-made', {...})         â”‚
     â”‚    clientMsgId: "1234_abc"                          â”‚
     â”‚                                                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    WebSocket                        â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                      â”‚
     â”‚ 3. Backend receives move-made                       â”‚
     â”‚                                                      â”‚
     â”‚ 4. state.addEvent({                                 â”‚
     â”‚      type: 'move.played',                           â”‚
     â”‚      seq: 42,  â† ASSIGNED BY BACKEND                â”‚
     â”‚      san: 'e4',                                     â”‚
     â”‚      fen: '...',                                    â”‚
     â”‚      userId: 'userA'                                â”‚
     â”‚    })                                               â”‚
     â”‚                                                      â”‚
     â”‚ 5. Send ACK to Client A                             â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚    {                                                â”‚
     â”‚      type: 'ack',                                   â”‚
     â”‚      clientMsgId: "1234_abc",                       â”‚
     â”‚      seq: 42,                                       â”‚
     â”‚      nodeId: "node_..."                             â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚ 6. Broadcast to ALL clients (including A)           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚    {                                                â”‚
     â”‚      type: 'move.played',                           â”‚
     â”‚      seq: 42,                                       â”‚
     â”‚      san: 'e4',                                     â”‚
     â”‚      fen: '...',                                    â”‚
     â”‚      tree: {...},                                   â”‚
     â”‚      userId: 'userA'                                â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚ 7. Client A: Skip (self-sent)                       â”‚
     â”‚                                                      â”‚
     â”‚                                    8. Client B: Apply move
     â”‚                                       - Check seq: 42 == lastAppliedSeq + 1 âœ“
     â”‚                                       - Update tree, board, notation
     â”‚                                       - lastAppliedSeq = 42
     â”‚                                       - User sees move on board
     â”‚                                                      â”‚
```

## Event Flow - Chapter Changed

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client A â”‚                                           â”‚ Client B â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                      â”‚
     â”‚ 1. User clicks "Chapter 2"                          â”‚
     â”‚                                                      â”‚
     â”‚ 2. realtimeClient.send('chapter-changed', {...})    â”‚
     â”‚    clientMsgId: "5678_def"                          â”‚
     â”‚                                                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    WebSocket                        â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                      â”‚
     â”‚ 3. Backend receives chapter-changed                 â”‚
     â”‚                                                      â”‚
     â”‚ 4. state.addEvent({                                 â”‚
     â”‚      type: 'chapter.changed',                       â”‚
     â”‚      seq: 43,  â† ASSIGNED BY BACKEND                â”‚
     â”‚      chapterId: 'chapter2',                         â”‚
     â”‚      chapterName: 'Chapter 2',                      â”‚
     â”‚      userId: 'userA'                                â”‚
     â”‚    })                                               â”‚
     â”‚                                                      â”‚
     â”‚ 5. state.updatePresence(userA, 'chapter2')          â”‚
     â”‚                                                      â”‚
     â”‚ 6. Send ACK to Client A                             â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚    {                                                â”‚
     â”‚      type: 'ack',                                   â”‚
     â”‚      clientMsgId: "5678_def",                       â”‚
     â”‚      seq: 43                                        â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚ 7. Broadcast chapter.changed to ALL                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚    {                                                â”‚
     â”‚      type: 'chapter.changed',                       â”‚
     â”‚      seq: 43,                                       â”‚
     â”‚      chapterId: 'chapter2',                         â”‚
     â”‚      chapterName: 'Chapter 2',                      â”‚
     â”‚      userId: 'userA'                                â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚ 8. Broadcast presence.update to ALL                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚    {                                                â”‚
     â”‚      type: 'presence.update',                       â”‚
     â”‚      presence: [                                    â”‚
     â”‚        {userId: 'userA', username: 'Alice',         â”‚
     â”‚         chapterId: 'chapter2'},                     â”‚
     â”‚        {userId: 'userB', username: 'Bob',           â”‚
     â”‚         chapterId: 'chapter1'}                      â”‚
     â”‚      ]                                              â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚ 9. Client A: Skip (self-sent)                       â”‚
     â”‚                                                      â”‚
     â”‚                                    10. Client B: Switch chapter
     â”‚                                        - handleChapterSelect('chapter2')
     â”‚                                        - Load chapter data
     â”‚                                        - Update board
     â”‚                                        - Update presence display
     â”‚                                                      â”‚
```

## Event Flow - Reconnection & Sync

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client A â”‚                                           â”‚ Client B â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                      â”‚
     â”‚ 1. Client B disconnects (WiFi off)                  X
     â”‚    lastAppliedSeq: 42                               â”‚
     â”‚                                                      â”‚
     â”‚ 2. Client A makes moves (seq 43, 44, 45)           â”‚
     â”‚                                                      â”‚
     â”‚ 3. Client A changes chapter (seq 46)                â”‚
     â”‚                                                      â”‚
     â”‚                                    4. Client B reconnects
     â”‚                                       - WebSocket OPEN
     â”‚                                       - onConnectionChange(true)
     â”‚                                       - realtimeClient.onReconnect()
     â”‚                                                      â”‚
     â”‚                                    5. Send sync.request
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚    {                                                â”‚
     â”‚      type: 'sync.request',                          â”‚
     â”‚      studyId: '...',                                â”‚
     â”‚      lastSeq: 42  â† Last seq Client B has           â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚ 6. Backend: state.getEventsSince(42)                â”‚
     â”‚    Returns: [event43, event44, event45, event46]    â”‚
     â”‚                                                      â”‚
     â”‚ 7. Send sync.response                               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚    {                                                â”‚
     â”‚      type: 'sync.response',                         â”‚
     â”‚      studyId: '...',                                â”‚
     â”‚      currentSeq: 46,                                â”‚
     â”‚      activeChapterId: 'chapter2',                   â”‚
     â”‚      events: [                                      â”‚
     â”‚        {type: 'move.played', seq: 43, ...},         â”‚
     â”‚        {type: 'move.played', seq: 44, ...},         â”‚
     â”‚        {type: 'move.played', seq: 45, ...},         â”‚
     â”‚        {type: 'chapter.changed', seq: 46, ...}      â”‚
     â”‚      ],                                             â”‚
     â”‚      presence: [...]                                â”‚
     â”‚    }                                                â”‚
     â”‚                                                      â”‚
     â”‚                                    8. Client B: Apply events
     â”‚                                       - Sort by seq
     â”‚                                       - Apply event 43 (move)
     â”‚                                       - Apply event 44 (move)
     â”‚                                       - Apply event 45 (move)
     â”‚                                       - Apply event 46 (chapter change)
     â”‚                                       - lastAppliedSeq = 46
     â”‚                                       - Update presence
     â”‚                                       - Client B now in sync!
     â”‚                                                      â”‚
```

## Sequencing & Ordering

```
Backend State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StudyState for study "ABC123"                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ seq: 46  â† Monotonic counter                         â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ events: [                                             â”‚ â”‚
â”‚  â”‚   {seq: 1, type: 'chapter.created', ...},            â”‚ â”‚
â”‚  â”‚   {seq: 2, type: 'move.played', san: 'e4', ...},     â”‚ â”‚
â”‚  â”‚   {seq: 3, type: 'move.played', san: 'e5', ...},     â”‚ â”‚
â”‚  â”‚   ...                                                 â”‚ â”‚
â”‚  â”‚   {seq: 43, type: 'move.played', san: 'Nf3', ...},   â”‚ â”‚
â”‚  â”‚   {seq: 44, type: 'move.played', san: 'Nc6', ...},   â”‚ â”‚
â”‚  â”‚   {seq: 45, type: 'move.played', san: 'Bb5', ...},   â”‚ â”‚
â”‚  â”‚   {seq: 46, type: 'chapter.changed', ...}            â”‚ â”‚
â”‚  â”‚ ]  â† Last 100 events kept                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RealtimeClient                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ lastAppliedSeq: 46  â† Last event applied             â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ eventBuffer: []  â† Empty when in sync                â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ outbox: {}  â† Empty when all ACKed                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Out-of-Order Handling:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scenario: Events arrive out of order                      â”‚
â”‚                                                             â”‚
â”‚  lastAppliedSeq: 42                                         â”‚
â”‚                                                             â”‚
â”‚  Receive event seq=45  (expected 43)                       â”‚
â”‚    â†’ Buffer: [event45]                                     â”‚
â”‚                                                             â”‚
â”‚  Receive event seq=44  (expected 43)                       â”‚
â”‚    â†’ Buffer: [event45, event44]                            â”‚
â”‚                                                             â”‚
â”‚  Receive event seq=43  (expected 43) âœ“                     â”‚
â”‚    â†’ Apply event43, lastAppliedSeq = 43                    â”‚
â”‚    â†’ Flush buffer:                                         â”‚
â”‚       - Sort by seq: [event44, event45]                    â”‚
â”‚       - Apply event44, lastAppliedSeq = 44                 â”‚
â”‚       - Apply event45, lastAppliedSeq = 45                 â”‚
â”‚    â†’ Buffer: []                                            â”‚
â”‚                                                             â”‚
â”‚  Result: All events applied in correct order!              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Presence Tracking

```
Backend:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StudyState.presence                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Map(                                                  â”‚ â”‚
â”‚  â”‚   'userA' â†’ {                                         â”‚ â”‚
â”‚  â”‚     username: 'Alice',                                â”‚ â”‚
â”‚  â”‚     chapterId: 'chapter2',                            â”‚ â”‚
â”‚  â”‚     lastSeen: 1699999999999                           â”‚ â”‚
â”‚  â”‚   },                                                  â”‚ â”‚
â”‚  â”‚   'userB' â†’ {                                         â”‚ â”‚
â”‚  â”‚     username: 'Bob',                                  â”‚ â”‚
â”‚  â”‚     chapterId: 'chapter1',                            â”‚ â”‚
â”‚  â”‚     lastSeen: 1699999999998                           â”‚ â”‚
â”‚  â”‚   }                                                   â”‚ â”‚
â”‚  â”‚ )                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend Display:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¥ Active Users (2)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ¢ Alice                              Chapter 2       â”‚ â”‚
â”‚  â”‚ ğŸŸ¢ Bob                                Chapter 1       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Diagnostics Panel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Sync Status                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Status:        ğŸŸ¢ Connected                           â”‚ â”‚
â”‚  â”‚ Last Seq:      46                                     â”‚ â”‚
â”‚  â”‚ Study ID:      507f1f77...                            â”‚ â”‚
â”‚  â”‚ Chapter ID:    60d5ec49...                            â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ Recent Events:                                        â”‚ â”‚
â”‚  â”‚ â€¢ move.played (seq: 45)                               â”‚ â”‚
â”‚  â”‚ â€¢ chapter.changed (seq: 46)                           â”‚ â”‚
â”‚  â”‚ â€¢ presence.update (seq: N/A)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**This architecture ensures:**
- âœ… Continuous event streaming (no one-shot)
- âœ… Ordered delivery (monotonic seq)
- âœ… Guaranteed delivery (ACK + resend)
- âœ… Perfect reconnection (sync protocol)
- âœ… Live presence (real-time roster)
- âœ… Full observability (diagnostics)








